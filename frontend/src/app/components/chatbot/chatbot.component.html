<div class="chatbot-container">
  <!-- Header with Theme Switcher -->
  <mat-card class="chatbot-header">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>chat</mat-icon>
        Tuesday: Chatbot Interface
      </mat-card-title>
      <mat-card-subtitle>
        Demonstrating: Confidence Signaling, Uncertainty, Correction Loops, Interruption, Context Visibility
      </mat-card-subtitle>
      <div class="header-actions">
        <button mat-icon-button
                (click)="toggleTheme()"
                [matTooltip]="(theme$ | async) === 'dark' ? 'Switch to Colorful Theme' : 'Switch to Dark Theme'"
                aria-label="Toggle theme">
          <mat-icon>{{ (theme$ | async) === 'dark' ? 'light_mode' : 'dark_mode' }}</mat-icon>
        </button>
        <mat-slide-toggle [(ngModel)]="showContextPanel" color="primary">
          Show Context
        </mat-slide-toggle>
      </div>
    </mat-card-header>
  </mat-card>

  <!-- Context Visibility Panel -->
  <mat-expansion-panel [(expanded)]="showContextPanel" *ngIf="showContextPanel">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>memory</mat-icon>
        Conversation Context
      </mat-panel-title>
      <mat-panel-description>
        Last 10 context items
      </mat-panel-description>
    </mat-expansion-panel-header>

    <mat-list *ngIf="conversationContext.length > 0; else noContext">
      <mat-list-item *ngFor="let item of conversationContext">
        <mat-icon matListItemIcon>label</mat-icon>
        <div matListItemTitle>{{ item.key }}</div>
        <div matListItemLine>{{ item.value }}</div>
        <span matListItemMeta class="context-time">{{ item.timestamp | date:'shortTime' }}</span>
      </mat-list-item>
    </mat-list>

    <ng-template #noContext>
      <p class="context-empty">No context available</p>
    </ng-template>
  </mat-expansion-panel>

  <!-- Intro Card -->
  <mat-card class="intro-card">
    <mat-card-header>
      <mat-card-title>Key UX Patterns</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ul>
        <li><strong>Confidence levels:</strong> Every response shows certainty with color + icon + border</li>
        <li><strong>Source transparency:</strong> See what data the AI used</li>
        <li><strong>Correction loops:</strong> Fix misunderstandings mid-conversation</li>
        <li><strong>Uncertainty display:</strong> AI suggests alternatives when unsure</li>
      </ul>
      <p class="try-it">
        <mat-icon inline>info</mat-icon>
        Try asking: "What are confidence levels?" or "How does routing work?"
      </p>
    </mat-card-content>
  </mat-card>

  <!-- Messages Container -->
  <div class="messages-container" role="log" aria-live="polite" aria-label="Chat messages">
    <div *ngFor="let message of messages; let i = index"
         class="message-wrapper">

      <!-- User Message -->
      <mat-card *ngIf="message.type === 'user'" class="message user-message">
        <mat-card-header>
          <mat-icon mat-card-avatar>person</mat-icon>
          <mat-card-title>You</mat-card-title>
          <mat-card-subtitle>{{ message.timestamp | date:'short' }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          {{ message.content }}
        </mat-card-content>
      </mat-card>

      <!-- System Message -->
      <mat-card *ngIf="message.type === 'system'" class="message system-message">
        <mat-card-header>
          <mat-icon mat-card-avatar color="warn">settings</mat-icon>
          <mat-card-title>System</mat-card-title>
          <mat-card-subtitle>{{ message.timestamp | date:'short' }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>{{ message.content }}</p>

          <!-- Failure State Details -->
          <div *ngIf="message.data?.failure_state" class="failure-state">
            <mat-divider></mat-divider>
            <h4>
              <mat-icon color="warn">error_outline</mat-icon>
              Error Details
            </h4>
            <p><strong>Type:</strong> {{ message.data?.failure_state?.type }}</p>
            <p><strong>Details:</strong> {{ message.data?.failure_state?.message }}</p>
            <p *ngIf="message.data?.failure_state?.user_action">
              <mat-icon inline>lightbulb</mat-icon>
              <strong>Suggested Action:</strong> {{ message.data?.failure_state?.user_action }}
            </p>
          </div>

          <!-- Alternative Interpretations -->
          <div *ngIf="message.data?.alternative_interpretations && (message.data?.alternative_interpretations?.length ?? 0) > 0"
               class="alternatives">
            <mat-divider></mat-divider>
            <h4>
              <mat-icon color="warn">help_outline</mat-icon>
              Did you mean:
            </h4>
            <mat-chip-set>
              <mat-chip *ngFor="let alt of message.data?.alternative_interpretations">
                {{ alt }}
              </mat-chip>
            </mat-chip-set>
          </div>
        </mat-card-content>

        <mat-card-actions *ngIf="message.data?.failure_state?.retry_suggested">
          <button mat-raised-button
                  color="accent"
                  (click)="userInput = conversationContext[conversationContext.length - 2]?.value || ''; sendMessage()">
            <mat-icon>refresh</mat-icon>
            Retry
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Assistant Message -->
      <mat-card *ngIf="message.type === 'assistant' && message.data"
                class="message assistant-message"
                [ngClass]="'confidence-' + getConfidenceClass(message.data.confidence)">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">smart_toy</mat-icon>
          <mat-card-title>AI Assistant</mat-card-title>
          <mat-card-subtitle>{{ message.timestamp | date:'short' }}</mat-card-subtitle>

          <!-- Confidence Badge -->
          <mat-chip-set class="confidence-chips">
            <mat-chip [highlighted]="true"
                      class="confidence-badge {{ getConfidenceClass(message.data.confidence) }}">
              <mat-icon matChipAvatar>{{ getConfidenceIcon(message.data.confidence) }}</mat-icon>
              {{ getConfidenceLabel(message.data.confidence) }}
              ({{ (message.data.confidence * 100).toFixed(0) }}%)
            </mat-chip>
          </mat-chip-set>
        </mat-card-header>

        <mat-card-content>
          <p>{{ message.content }}</p>

          <!-- Sources Section -->
          <mat-expansion-panel *ngIf="message.data.sources && message.data.sources.length > 0">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>source</mat-icon>
                Sources Consulted ({{ message.data.sources.length }})
              </mat-panel-title>
            </mat-expansion-panel-header>

            <mat-list>
              <mat-list-item *ngFor="let source of message.data.sources">
                <mat-icon matListItemIcon>description</mat-icon>
                <div matListItemTitle>{{ source.name }}</div>
                <div matListItemLine>{{ source.type }}</div>
                <div matListItemMeta class="source-relevance">
                  <mat-progress-bar mode="determinate"
                                    [value]="source.relevance * 100"
                                    [color]="'primary'">
                  </mat-progress-bar>
                  <span class="relevance-label">{{ (source.relevance * 100).toFixed(0) }}%</span>
                </div>
              </mat-list-item>
            </mat-list>
          </mat-expansion-panel>

          <!-- Tools Used Section -->
          <mat-expansion-panel *ngIf="message.data.tools_used && message.data.tools_used.length > 0">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>build</mat-icon>
                Tools Used ({{ message.data.tools_used.length }})
              </mat-panel-title>
            </mat-expansion-panel-header>

            <mat-chip-set>
              <mat-chip *ngFor="let tool of message.data.tools_used">
                <mat-icon matChipAvatar [color]="tool.success ? 'primary' : 'warn'">
                  {{ tool.success ? 'check_circle' : 'error' }}
                </mat-icon>
                {{ tool.name }}
                <span matChipTrailingIcon>{{ tool.execution_time_ms }}ms</span>
              </mat-chip>
            </mat-chip-set>
          </mat-expansion-panel>

          <!-- Alternative Interpretations for Low Confidence -->
          <div *ngIf="message.data.alternative_interpretations && (message.data.alternative_interpretations.length ?? 0) > 0"
               class="alternatives-low-conf">
            <mat-divider></mat-divider>
            <h4>
              <mat-icon color="warn">warning</mat-icon>
              I'm not certain. Did you mean:
            </h4>
            <mat-chip-set>
              <mat-chip *ngFor="let alt of message.data.alternative_interpretations" color="warn">
                {{ alt }}
              </mat-chip>
            </mat-chip-set>
          </div>
        </mat-card-content>

        <!-- Correction UI -->
        <mat-card-actions>
          <button mat-button
                  *ngIf="message.data.can_correct && showingCorrection !== 'msg-' + i"
                  (click)="showCorrection(i)"
                  aria-label="Correct this response">
            <mat-icon>edit</mat-icon>
            Correct this
          </button>

          <!-- Inline Correction Form -->
          <div *ngIf="showingCorrection === 'msg-' + i" class="correction-form">
            <mat-form-field appearance="outline" class="correction-field">
              <mat-label>Correction</mat-label>
              <input matInput
                     [(ngModel)]="correctionText"
                     placeholder="I meant..."
                     (keyup.enter)="submitCorrection(message, i)">
              <mat-icon matPrefix>edit_note</mat-icon>
            </mat-form-field>
            <button mat-raised-button
                    color="primary"
                    (click)="submitCorrection(message, i)"
                    [disabled]="!correctionText.trim()">
              <mat-icon>send</mat-icon>
              Submit
            </button>
            <button mat-button (click)="cancelCorrection()">
              Cancel
            </button>
          </div>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-container" role="status" aria-live="polite">
      <mat-spinner diameter="40" color="primary"></mat-spinner>
      <p>Thinking...</p>
    </div>
  </div>

  <!-- Input Area -->
  <mat-card class="input-container">
    <mat-card-content>
      <div class="input-row">
        <mat-form-field appearance="outline" class="message-input-field">
          <mat-label>Type your message...</mat-label>
          <input matInput
                 [(ngModel)]="userInput"
                 [disabled]="isLoading"
                 (keyup.enter)="sendMessage()"
                 placeholder="Ask me anything..."
                 aria-label="Message input">
          <mat-icon matPrefix>chat_bubble_outline</mat-icon>
        </mat-form-field>

        <button mat-raised-button
                color="primary"
                (click)="sendMessage()"
                [disabled]="!userInput.trim() || isLoading"
                matTooltip="Send message (Enter)"
                aria-label="Send message">
          <mat-icon>send</mat-icon>
          Send
        </button>

        <button mat-icon-button
                color="warn"
                *ngIf="canInterrupt"
                (click)="interruptResponse()"
                matTooltip="Stop response"
                aria-label="Interrupt response">
          <mat-icon>stop</mat-icon>
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>
