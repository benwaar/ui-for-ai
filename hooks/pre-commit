#!/bin/bash
# Generic Git pre-commit hook for this UI repo
#
# Lightweight checks before commit:
# 1. Validate key JSON files if present
# 2. (Placeholder) room for adding project-specific checks later

set -e

# Get the git repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "======================================================================"
echo "Running pre-commit checks..."
echo "======================================================================"

# Track overall success
ALL_PASSED=true

# Function to run a check
run_check() {
    local description="$1"
    shift
    local cmd=("$@")

    echo ""
    echo "üîç $description..."

    if "${cmd[@]}" > /tmp/pre-commit-check.log 2>&1; then
        echo "‚úÖ $description passed"
        return 0
    else
        echo "‚ùå $description failed"
        echo ""
        cat /tmp/pre-commit-check.log
        ALL_PASSED=false
        return 1
    fi
}

# Check 1: Validate frontend/package.json (if present)
validate_frontend_package_json() {
    local pkg="frontend/package.json"
    if [ ! -f "$pkg" ]; then
        echo "Note: $pkg not found ‚Äî skipping"
        return 0
    fi
    if ! python3 -m json.tool "$pkg" > /dev/null 2>&1; then
        echo "Error: $pkg is not valid JSON"
        return 1
    fi
    return 0
}

# Check 2: Validate backend/requirements.txt exists (if backend present)
validate_backend_requirements() {
    if [ -d "backend" ] && [ ! -f "backend/requirements.txt" ]; then
        echo "Note: backend directory present but requirements.txt missing"
        # Non-fatal for now; return success
        return 0
    fi
    return 0
}

# Run checks
run_check "Frontend package.json validation" validate_frontend_package_json || true
run_check "Backend requirements presence" validate_backend_requirements || true

# Check 3: TypeScript compile (no emit) in frontend
validate_ts_compile() {
    if [ ! -d "frontend" ]; then
        echo "Note: frontend directory not found ‚Äî skipping TypeScript compile check"
        return 0
    fi
    if ! command -v npx >/dev/null 2>&1; then
        echo "Note: npx not found ‚Äî skipping TypeScript compile check"
        return 0
    fi
    (cd frontend && npx tsc --noEmit) >/dev/null 2>&1 || {
        echo "Error: TypeScript compile failed in frontend"
        # show brief output for context
        (cd frontend && npx tsc --noEmit) 2>&1 | head -n 20
        return 1
    }
    return 0
}

run_check "TypeScript compile (no emit)" validate_ts_compile || true

# Check 4: ESLint validation on staged files
validate_eslint() {
    if [ ! -d "frontend" ]; then
        echo "Note: frontend directory not found ‚Äî skipping ESLint check"
        return 0
    fi

    # Get staged TypeScript and HTML files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'frontend/.*\.(ts|html)$' || true)

    if [ -z "$STAGED_FILES" ]; then
        echo "Note: No TypeScript/HTML files staged ‚Äî skipping ESLint"
        return 0
    fi

    if ! command -v npx >/dev/null 2>&1; then
        echo "Note: npx not found ‚Äî skipping ESLint check"
        return 0
    fi

    # Load NVM and run ESLint on staged files only
    (cd frontend && bash -c 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use && npx eslint '"${STAGED_FILES}"'') || {
        echo "Error: ESLint found issues in staged files"
        echo ""
        echo "To fix automatically, run:"
        echo "  cd frontend && npm run lint:fix"
        echo ""
        return 1
    }
    return 0
}

run_check "ESLint validation" validate_eslint || true

# Check 5: HTML validation
validate_html() {
    if [ ! -d "frontend" ]; then
        echo "Note: frontend directory not found ‚Äî skipping HTML validation"
        return 0
    fi

    # Get staged HTML files
    STAGED_HTML=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'frontend/.*\.html$' || true)

    if [ -z "$STAGED_HTML" ]; then
        echo "Note: No HTML files staged ‚Äî skipping HTML validation"
        return 0
    fi

    if ! command -v npx >/dev/null 2>&1; then
        echo "Note: npx not found ‚Äî skipping HTML validation"
        return 0
    fi

    # Change to repo root and run html-validate on staged files
    # html-validate expects paths relative to where it's run
    local html_files=""
    for file in $STAGED_HTML; do
        html_files="$html_files $file"
    done

    if ! npx html-validate $html_files 2>&1; then
        echo ""
        echo "Error: HTML validation found issues"
        echo ""
        echo "To view all issues:"
        echo "  cd frontend && npm run validate:html"
        echo ""
        echo "Common fixes:"
        echo "  - Add alt attributes to <img> elements"
        echo "  - Associate <label> elements with form inputs"
        echo "  - Add aria-label to buttons with only icons"
        echo "  - Fix improper element nesting"
        echo "  - Add required ARIA attributes to progress bars"
        echo ""
        return 1
    fi
    return 0
}

run_check "HTML validation" validate_html || true

# Check 6: UI-focused unit tests
validate_tests() {
    if [ ! -d "frontend" ]; then
        echo "Note: frontend directory not found ‚Äî skipping unit tests"
        return 0
    fi

    if ! command -v npx >/dev/null 2>&1; then
        echo "Note: npx not found ‚Äî skipping unit tests"
        return 0
    fi

    # Load NVM and run UI-focused tests (theme service, etc.)
    # HTTP service tests are excluded as project focuses on UI elements
    (cd frontend && bash -c 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use && npx vitest run') || {
        echo "Error: UI tests failed"
        echo ""
        echo "To run tests locally:"
        echo "  cd frontend && npx vitest run"
        echo ""
        return 1
    }
    return 0
}

run_check "Unit tests" validate_tests || true

# Clean up temp file
rm -f /tmp/pre-commit-check.log

echo ""
echo "======================================================================"

if [ "$ALL_PASSED" = true ]; then
    echo "‚úÖ All pre-commit checks passed (non-applicable checks were skipped)."
    echo "======================================================================"
    exit 0
else
    echo "‚ùå Some pre-commit checks failed"
    echo "======================================================================"
    echo ""
    echo "To fix:"
    echo "  ‚Ä¢ Frontend: Ensure frontend/package.json is valid JSON"
    echo "  ‚Ä¢ Backend: Provide backend/requirements.txt if using Python backend"
    echo ""
    echo "To skip these checks (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
